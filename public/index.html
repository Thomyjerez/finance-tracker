<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Control de Gastos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* estilos */
        :root {
            --primary: #2563eb;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #111827;
        }

        /* nuevo boton para subida de archivos */
        .upload-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .custom-file-upload {
            border: 2px dashed #cbd5e1;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            color: #475569;
            font-weight: bold;
            transition: 0.3s;
            background-color: #f8fafc;
            display: inline-block;
        }

        .custom-file-upload:hover {
            border-color: var(--primary);
            background-color: #eff6ff;
            color: var(--primary);
        }

        .file-name-display {
            color: #6b7280;
            font-size: 0.9rem;
            flex-grow: 1;
            font-style: italic;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        /* estilos para el filtro */
        .filter-section {
            background: var(--card);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: bold;
        }

        select {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #cbd5e1;
            font-size: 1rem;
            font-weight: bold;
            color: #475569;
            outline: none;
            cursor: pointer;
            background-color: #f8fafc;
            transition: 0.3s;
        }

        select:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-top: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container,
        .table-container {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid #e5e7eb;
            color: #6b7280;
            font-size: 0.85rem;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .cat-super {
            background: #dcfce7;
            color: #166534;
        }

        .cat-trans {
            background: #dbeafe;
            color: #1e40af;
        }

        .cat-comida {
            background: #fee2e2;
            color: #991b1b;
        }

        .cat-suscr {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .cat-varios {
            background: #f3f4f6;
            color: #374151;
        }
        /* estilos del modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2); }
        .modal-content h3 { margin-top: 0; margin-bottom: 10px; color: #111827; }
        .modal-desc-text { font-size: 0.9rem; color: #6b7280; margin-bottom: 20px; font-style: italic; }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; color: #374151; }
        .modal-form-group input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; font-family: inherit; outline: none; transition: 0.2s;}
        .modal-form-group input:focus { border-color: var(--primary); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background-color: #f3f4f6; color: #374151; }
        .btn-cancel:hover { background-color: #e5e7eb; }
        /* notificaciones flotantes */
        .toast-notif { visibility: hidden; min-width: 250px; background-color: #374151; color: #fff; text-align: center; border-radius: 8px; padding: 15px 20px; position: fixed; z-index: 1001; left: 50%; bottom: 20px; transform: translateX(-50%); font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: 0.3s; opacity: 0; }
        .toast-notif.show { visibility: visible; bottom: 40px; opacity: 1; }
        .toast-error { background-color: #ef4444; } /* Rojo para errores */
        .toast-success { background-color: #10b981; } /* Verde para √©xitos */
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üí∏ Finance Tracker</h1>
            <button onclick="abrirModalManual()" style="background-color: #10b981;">‚ûï Agregar Gasto</button>
        </header>

        <div class="upload-card">
            <input type="file" id="archivoInput" accept=".csv, .pdf, .PDF, application/pdf" style="display: none;">

            <label for="archivoInput" class="custom-file-upload">
                üìÅ Seleccionar Resumen
            </label>

            <span id="fileName" class="file-name-display">Ning√∫n archivo seleccionado</span>

            <button id="uploadBtn" onclick="subirArchivo()">Analizar Resumen</button>
        </div>

        <div class="filter-section">
            <label for="mesFilter">Mes :</label>
            <select id="mesFilter">
                <option value="TODOS">Todos los meses</option>
            </select>

            <label for="catFilter" style="margin-left: 15px;">üè∑Ô∏è Categor√≠a:</label>
            <select id="catFilter">
                <option value="TODAS">Todas las categor√≠as</option>
            </select>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Gastado</div>
                <div class="stat-value" id="totalGasto">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Categor√≠a M√°s Cara</div>
                <div class="stat-value" id="topCategoria">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Movimientos</div>
                <div class="stat-value" id="totalTransacciones">0</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container">
                <h3>Distribuci√≥n de Gastos</h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="miGrafico"></canvas>
                </div>
            </div>
            <div class="table-container">
                <h3>√öltimos Movimientos</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Categor√≠a</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Categorizar Gasto</h3>
            <p id="modalDesc" class="modal-desc-text"></p>

            <div class="modal-form-group">
                <label>Categoria nueva:</label>
                <input type="text" id="modalCategoria" placeholder="Escribe la categor√≠a...">
            </div>

            <div class="modal-form-group">
                <label>Palabra clave para recordar (Ej: netflix):</label>
                <input type="text" id="modalPalabraClave" placeholder="Palabra clave...">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                <button id="btnGuardarModal" onclick="guardarAprendizaje()">Guardar</button>
            </div>
        </div>
    </div>
    <div id="toastNotif" class="toast-notif">Mensaje</div>
    <div id="manualModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Agregar Gasto en Efectivo</h3>
            
            <div class="modal-form-group">
                <label>Fecha (Ej: 23/02/2026):</label>
                <input type="text" id="manualFecha" placeholder="DD/MM/AAAA">
            </div>
            <div class="modal-form-group">
                <label>Descripci√≥n:</label>
                <input type="text" id="manualDesc" placeholder="Ej: Kiosco, Verduler√≠a, Taxi...">
            </div>
            <div class="modal-form-group">
                <label>Monto ($):</label>
                <input type="number" id="manualMonto" placeholder="Ej: 2500">
            </div>
            <div class="modal-form-group">
                <label>Categor√≠a:</label>
                <select id="manualCat" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                    <option value="Comida">Comida</option>
                    <option value="Supermercado">Supermercado</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Salud">Salud</option>
                    <option value="Varios" selected>Varios</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="cerrarModalManual()">Cancelar</button>
                <button id="btnGuardarManual" onclick="guardarGastoManual()">Guardar</button>
            </div>
        </div>
    </div>
    <script>
        let todosLosGastos = []; // variable global para almacenar los gastos

        // alertas pro
        function mostrarAlerta(mensaje, esError = false) {
            const toast = document.getElementById("toastNotif");
            toast.innerText = mensaje;
            
            toast.className = "toast-notif show " + (esError ? "toast-error" : "toast-success");
            
            setTimeout(() => {
                toast.className = toast.className.replace("show", "").trim();
            }, 3500);
        }

        // mostrar el nombre del archivo seleccionado
    document.getElementById('archivoInput').addEventListener('change', function() {
        const nameSpan = document.getElementById('fileName');
        if (this.files && this.files.length > 0) {
            nameSpan.textContent = "üìÑ " + this.files[0].name;
            nameSpan.style.color = "#10b981"; // verde cuando hay archivo
            nameSpan.style.fontWeight = "bold";
        } else {
            nameSpan.textContent = 'Ning√∫n archivo seleccionado';
            nameSpan.style.color = "#6b7280";
            nameSpan.style.fontWeight = "normal";
        }
    });

        //logica de subida
        async function subirArchivo() {
            const input = document.getElementById('archivoInput');
            const btn = document.getElementById('uploadBtn');

            if (!input.files[0]) return mostrarAlerta("‚ö†Ô∏è Por favor selecciona un archivo.", true);

            const formData = new FormData();
            formData.append('archivo', input.files[0]);

            const textOriginal = btn.textContent;
            btn.textContent = "Procesando...";
            btn.disabled = true;

            try {
                const res = await fetch('/subir-resumen', { method: 'POST', body: formData });
            if (!res.ok) throw new Error("Error en el servidor al subir.");
            const datos = await res.json();
            
            mostrarAlerta(datos.mensaje);
            
            input.value = '';
            document.getElementById('fileName').textContent = 'Ning√∫n archivo seleccionado';
            document.getElementById('fileName').style.color = "#6b7280";
            
            // llamamos a cargarDatos para que se actualice la pantalla
            await cargarDatos();
            } catch (e) {
                mostrarAlerta("‚ùå Error: " + e.message, true);
            } finally {
                btn.innerText = textOriginal;
                btn.disabled = false;
            }
        }
        //logica de carga desde la base de datos
        async function cargarDatos() {
        try {
            const res = await fetch('/api/gastos');
            const data = await res.json();
            
            // garantizamos que siempre sea una lista 
            todosLosGastos = Array.isArray(data) ? data : [];

            if (todosLosGastos.length === 0) {
                console.log("No hay gastos guardados todav√≠a.");
                return;
            }

            // si hay gastos actualizamos los filtros y dibujamos la pantalla
            configurarFiltros()
            renderizarDashboard(todosLosGastos); 
            
        } catch (error) {
            console.error("Error cargando datos:", error);
        }
    }
        //extrae el mes y a√±o de cualquier fecha: 02.01.26 a 02/01/2026
        function obtenerMesAnio(fechaStr) {
            if (!fechaStr) return 'Desconocido';
            const partes = fechaStr.split(/[\/\-\.]/);//separo por barras guion o puntos
            if (fechaStr.includes('Mes:')) return fechaStr.replace('Mes:', '').trim() + ' 2026';
            if (partes.length >= 3) {
                const mes = partes[1].padStart(2, '0');// para que 1 sea 01
                let anio = partes[2];
                if (anio.length === 2) anio = "20" + anio; //convierte 26 a 2026
                return `${mes}/${anio}`;
            }
            return 'Desconocido';
        }

        function configurarFiltros() {

            const selectMes = document.getElementById('mesFilter');
            const selectCat = document.getElementById('catFilter');
            const mesesUnicos = new Set();
            const categoriasUnicas = new Set();

            //logica para recoletar datos de los gastos
            todosLosGastos.forEach(g =>{
                const mesAnio = obtenerMesAnio(g.fecha);
                if(mesAnio !== 'Desconocido') mesesUnicos.add(mesAnio);
                if(g.categoria) categoriasUnicas.add(g.categoria);
            });
            //llanar el menu de meses

            selectMes.innerHTML = '<option value="TODOS">Todos los meses</option>';
            Array.from(mesesUnicos).sort().reverse().forEach(mes => {
                const opcion = document.createElement('option');
                opcion.value = mes;
                opcion.textContent = mes;
                selectMes.appendChild(opcion);
            });

            //llenar el menu de categorias
            selectCat.innerHTML = '<option value="TODAS">Todas las categor√≠as</option>';
            Array.from(categoriasUnicas).sort().forEach(cat => {
                const opcion = document.createElement('option');
                opcion.value = cat;
                opcion.textContent = cat;
                selectCat.appendChild(opcion);
            });

            //el motor para aplicar ambos filtros al mismo tiempo
            const aplicarFiltros = ()=>{
                const mesSel = selectMes.value;
                const catSel = selectCat.value;

                let filtrados = todosLosGastos;

                if(mesSel !== 'TODOS'){
                    filtrados = filtrados.filter(g => obtenerMesAnio(g.fecha)=== mesSel);
                }

                if(catSel !== 'TODAS'){
                    filtrados = filtrados.filter(g=> g.categoria === catSel);
                }
                renderizarDashboard(filtrados);
            };

            //reaccion del menu al clik
            selectMes.onchange = aplicarFiltros;
            selectCat.onchange = aplicarFiltros;

        }

        //funciones de dibujado
        //actualiza todo junto 
        function renderizarDashboard(gastosParaMostrar) {
            actualizarTabla(gastosParaMostrar);
            actualizarEstadisticas(gastosParaMostrar);
            dibujarGrafico(gastosParaMostrar);
        }

        function actualizarTabla(gastos) {
            const tbody = document.getElementById('tablaBody');
            tbody.innerHTML = '';

            gastos.forEach(g => {
                let claseColor = 'cat-varios';
                if (g.categoria === 'Supermercado') claseColor = 'cat-super';
                if (g.categoria === 'Transporte') claseColor = 'cat-trans';
                if (g.categoria === 'Comida') claseColor = 'cat-comida';
                if (g.categoria === 'Suscripciones') claseColor = 'cat-suscr';

                const fila = `
                <tr>
                    <td>${g.fecha || '-'}</td>
                    <td>${g.descripcion}</td>
                    <td>
                        <span class="badge ${claseColor}" style="cursor: pointer;" onclick="ense√±arApp('${g.descripcion}')" title="Haz clic para ense√±arme">
                            ${g.categoria} ‚úèÔ∏è
                        </span>
                    </td>
                    <td style="font-weight:bold;">$${g.monto.toLocaleString('es-AR', {minimumFractionDigits: 2})}</td>
                </tr>
            `;
                tbody.innerHTML += fila;
            });
        }

        // funcion nueva para ense√±arle a la app a hacer preguntas y mandarlas al backend
        function ense√±arApp(descripcionGasto){
            //muestra el nombre en el modal
            document.getElementById('modalDesc').innerText=`Gasto: "${descripcionGasto}"`;

            const palabras = descripcionGasto.split(' ');
            const sugerencia = palabras.length > 1 ? palabras[0] + " " + palabras[1] : palabras[0];

            document.getElementById('modalPalabraClave').value = sugerencia.toLowerCase();
            document.getElementById('modalCategoria').value = "";

            document.getElementById('editModal').style.display= 'flex';
        }

        function cerrarModal(){
            document.getElementById('editModal').style.display = 'none';
        }

        async function guardarAprendizaje() {
            const nuevaCategoria = document.getElementById('modalCategoria').value.trim();
            const palabraClave = document.getElementById('modalPalabraClave').value.trim();

            if (!nuevaCategoria || !palabraClave) {
                return mostrarAlerta("‚ö†Ô∏è Por favor completa los dos campos.", true);
            }

            const btn = document.getElementById('btnGuardarModal');
            btn.innerText = "‚è≥ Guardando...";
            btn.disabled = true;

            try {
                const respuesta = await fetch('/api/aprender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ palabraClave: palabraClave, categoria: nuevaCategoria })
                });

                // si el servidor falla (ej: 404 o 500) obliga a que nos diga por que
                if (!respuesta.ok) {
                    const errorDelServidor = await respuesta.text();
                    throw new Error(errorDelServidor);
                }

                const datos = await respuesta.json();
                
                mostrarAlerta(datos.mensaje); 
                cerrarModal();
                cargarDatos(); 
                
            } catch (error) {
                mostrarAlerta("‚ùå Error al guardar. Revisa la consola (F12).", true);
                console.error("Detalle del error:", error.message);
            } finally {
                btn.innerText = "Guardar";
                btn.disabled = false;
            }
        }


        function actualizarEstadisticas(gastos) {
            const total = gastos.reduce((sum, g) => sum + g.monto, 0);
            document.getElementById('totalGasto').innerText = `$${total.toLocaleString('es-AR', { minimumFractionDigits: 2 })}`;
            document.getElementById('totalTransacciones').innerText = gastos.length;

            const categorias = {}
            gastos.forEach(g => {
                categorias[g.categoria] = (categorias[g.categoria] || 0) + g.monto;
            })

            if (Object.keys(categorias).length > 0) {
                const topCat = Object.keys(categorias).reduce((a, b) => categorias[a] > categorias[b] ? a : b);
                document.getElementById('topCategoria').innerText = `${topCat} ($${categorias[topCat].toLocaleString('es-AR', { maximumFractionDigits: 0 })})`;
            } else {
                document.getElementById('topCategoria').innerText = '-';
            }
        }

        function dibujarGrafico(gastos) {
            const categorias = {}
            gastos.forEach(g => categorias[g.categoria] = (categorias[g.categoria] || 0) + g.monto)

            const ctx = document.getElementById('miGrafico').getContext('2d')
            if (window.miChart) window.miChart.destroy(); //destrye el grafico viejo antes de hacer el nuevo 

            window.miChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#4ade80', '#60a5fa', '#f87171', '#c084fc', '#9ca3af', '#fcd34d'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            })
        }
        // FUNCIONES DE GASTO MANUAL
        function abrirModalManual() {
            // autocompleta la fecha de hoy para mayor comodidad
            const hoy = new Date();
            const fechaHoy = `${hoy.getDate().toString().padStart(2, '0')}/${(hoy.getMonth() + 1).toString().padStart(2, '0')}/${hoy.getFullYear()}`;
            
            document.getElementById('manualFecha').value = fechaHoy;
            document.getElementById('manualDesc').value = '';
            document.getElementById('manualMonto').value = '';
            document.getElementById('manualModal').style.display = 'flex';
        }

        function cerrarModalManual() {
            document.getElementById('manualModal').style.display = 'none';
        }

        async function guardarGastoManual() {
            const fecha = document.getElementById('manualFecha').value.trim();
            const descripcion = document.getElementById('manualDesc').value.trim();
            const monto = document.getElementById('manualMonto').value.trim();
            const categoria = document.getElementById('manualCat').value;

            if (!descripcion || !monto) {
                return mostrarAlerta("‚ö†Ô∏è Por favor ingresa una descripci√≥n y un monto.", true);
            }

            const btn = document.getElementById('btnGuardarManual');
            btn.innerText = "‚è≥ Guardando...";
            btn.disabled = true;

            try {
                const respuesta = await fetch('/api/gastos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha, descripcion, monto, categoria })
                });

                if (!respuesta.ok) throw new Error("Fallo en el servidor al guardar.");
                
                const datos = await respuesta.json();
                mostrarAlerta(datos.mensaje);
                cerrarModalManual();
                
                // recarga la tabla para que aparezca el gasto instant√°neamente
                cargarDatos(); 
            } catch (error) {
                mostrarAlerta("‚ùå Error al guardar el gasto manual.", true);
                console.error(error);
            } finally {
                btn.innerText = "Guardar";
                btn.disabled = false;
            }
        }



        //iniciar
        cargarDatos();

    </script>
</body>

</html>